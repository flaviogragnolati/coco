generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                       String  @id @default(cuid())
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  phone         String?
  image         String?
  taxId         String?
  taxType       String?
  gender        String?
  isActive      Boolean   @default(true)
  deleted       Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  roles             Role[]             @relation("userRoles")
  addresses         Address[]          @relation("userAddresses")
  savedPaymentCards SavedPaymentCard[]
  notifications     Notification[]
  events            Event[]
  ProductRating     ProductRating[]
  userSettings      UserSettings[]
}

model UserSettings {
  id                   Int      @id @default(autoincrement())
  notificationsEnabled Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Role {
  id          Int      @id @default(autoincrement())
  type        RoleType
  name        String
  description String?
  rules       Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String?
  user   User?   @relation("userRoles", fields: [userId], references: [id])
}

enum RoleType {
  ADMIN
  BUYER
  ALLY // FRACTIONATOR + PICKER
  FRACTIONATOR
  PICKER
  SUPPLIER
  CARRIER
  GUEST
}

model Address {
  id          Int         @id @default(autoincrement())
  type        AddressType
  fullAddress String
  street      String
  number      String
  city        String
  state       String
  postalCode  String
  country     String
  description String?
  isActive    Boolean     @default(true)
  deleted     Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  userId     String?
  user       User?      @relation("userAddresses", fields: [userId], references: [id])
  supplierId Int?
  supplier   Supplier?  @relation("supplierAddresses", fields: [supplierId], references: [id])
  carrierId  Int?
  carrier    Carrier?   @relation("carrierAddresses", fields: [carrierId], references: [id])
  shipments  Shipment[]
  carts      Cart[]
}

enum AddressType {
  HOME
  WORK
  SHIPPING
  BILLING
  FRACTIONING
  SUPPLIER
  PICKUP
  CARRIER
}

model Carrier {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  image        String?
  phone        String?
  email        String?
  website      String?
  taxId        String?
  taxType      String?
  contactName  String?
  contactPhone String?
  contactEmail String?
  isActive     Boolean  @default(true)
  deleted      Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  addresses     Address[]       @relation("carrierAddresses")
  shipments     Shipment[]
  carrierRoutes CarrierRoutes[]

  carrierRates CarrierRate[]
}

model CarrierRoutes {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  origin      String
  destination String
  distance    Float // in km
  duration    Int // in days
  price       Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  carrierId Int
  carrier   Carrier       @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  rates     CarrierRate[]
}

model CarrierRate {
  id             Int      @id @default(autoincrement())
  name           String
  description    String?
  volumetricMoq  Float
  volumetricRate Float
  weightMoq      Float
  weightRate     Float
  rate           Float
  isFlatRate     Boolean  @default(false)
  isPerKg        Boolean  @default(false)
  isPerM3        Boolean  @default(false)
  isPerKm        Boolean  @default(false)
  isPerDay       Boolean  @default(false)
  isPerRoute     Boolean  @default(false)
  isPerShipment  Boolean  @default(false)
  isPerOrder     Boolean  @default(false)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  carrierId Int
  carrier   Carrier         @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  routes    CarrierRoutes[]
}

model Supplier {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  image        String?
  phone        String?
  email        String?
  website      String?
  taxId        String?
  taxType      String?
  contactName  String?
  contactPhone String?
  contactEmail String?
  pickupPolicy String?
  isActive     Boolean  @default(true)
  deleted      Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  addresses Address[] @relation("supplierAddresses")
  products  Product[]
  lots      Lot[]
}

model Product {
  id                     Int       @id @default(autoincrement())
  version                Int       @default(1)
  name                   String
  description            String?
  searchTags             String[]
  publicTags             String[]
  code                   String
  supplierCode           String?
  supplierUrl            String?
  images                 String[]
  currency               Currency? @default(ARS)
  // supplier side info
  price                  Float
  priceUnit              String
  priceUnitMultiplier    Float     @default(1)
  supplierMoqQty         Float
  supplierMoqQtyUnit     String
  supplierMultiplierUnit String
  supplierUnitMultiplier Float     @default(1)
  // customer side info
  customerMoq            Float
  customerUnit           String
  customerUnitMultiplier Float     @default(1)
  publicPrice            Float
  publicPriceUnit        String
  publicPriceMultiplier  Float     @default(1)
  minFractionPerUser     Int       @default(1)
  volumePerUnit          Float?
  weightPerUnit          Float?
  isActive               Boolean   @default(true)
  deleted                Boolean   @default(false)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  brandId    Int?
  brand      Brand?          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  categoryId Int?
  category   Category?       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  supplierId Int
  supplier   Supplier        @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  ratings    ProductRating[]
  cartItems  CartItem[]
}

enum Currency {
  USD
  EUR
  ARS
}

enum Unit {
  KG
  G
  LB
  OZ
  L
  ML
  UNIT
  BOX
  PACK
  M3
  FT3
  CM3
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  tags        String[]
  image       String?
  description String?
  isActive    Boolean  @default(true)
  deleted     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]
}

model Brand {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  image       String?
  isActive    Boolean   @default(true)
  deleted     Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
}

model ProductRating {
  id        Int      @id @default(autoincrement())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Cart {
  id        Int        @id @default(autoincrement())
  status    CartStatus
  userId    String
  addressId Int?
  paidAt    DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  items        CartItem[]
  address      Address?      @relation(fields: [addressId], references: [id], onDelete: Cascade)
  userPayments UserPayment[]

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

enum CartStatus {
  DRAFT // in user browser
  PENDING_PAYMENT // saved (for logged in customers) but not paid
  PAYMENT_FAILED // payment attempt failed
  PAYMENT_COMPLETED // payment succeeded, pending processing
  CANCELLED_BY_USER // user cancelled before processing
  CANCELLED_BY_ADMIN // admin cancelled before processing
  REFUNDED // refunded after processing
  EXPIRED // not completed in time
  IN_LOT // payment completed, being lotted
}

model CartItem {
  id              Int      @id @default(autoincrement())
  quantity        Float
  unit            String
  price           Float
  publicPrice     Float
  productSnapshot String // JSON snapshot of the product at the time of adding to cart
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  cartId    Int
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  lotId     Int?
  lot       Lot?    @relation(fields: [lotId], references: [id])
}

model Shipment {
  id          Int            @id @default(autoincrement())
  trackingId  String
  carrierName String         @map("carrier")
  status      ShipmentStatus
  eta         DateTime?
  startedAt   DateTime?
  arrivedAt   DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  addressId        Int
  address          Address           @relation(fields: [addressId], references: [id], onDelete: Cascade)
  carrierId        Int?
  carrier          Carrier?          @relation(fields: [carrierId], references: [id])
  packages         ShipmentPackage[]
  shipmentPayments ShipmentPayment[]
}

enum ShipmentStatus {
  ASSEMBLING // shipment being assembled
  IN_TRANSIT // shipment is in transit
  ARRIVED // shipment has arrived at destination
  CLOSED
  DELIVERED // shipment has been delivered
}

model UserPayment {
  id          Int           @id @default(autoincrement())
  amount      Float
  status      PaymentStatus
  transaction Json
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  cartId Int?
  cart   Cart? @relation(fields: [cartId], references: [id])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

model Lot {
  id             Int       @id @default(autoincrement())
  trackingNumber String
  status         LotStatus
  scheduledAt    DateTime
  consolidatedAt DateTime?
  orderSentAt    DateTime?
  confirmedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  supplierId  Int
  supplier    Supplier     @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  items       CartItem[]
  packages    Package[]
  lotPayments LotPayment[]
}

enum LotStatus {
  PENDING // lot opened but MOQ not yet met
  READY_TO_ORDER // MOQ met, ready to place order with supplier
  ORDER_SENT // order placed with supplier, pending confirmation
  CONFIRMED_BY_PROVIDER // supplier confirmed the order
  PACKAGE_READY // supplier packaged the lot, pending pickup
  IN_TRANSIT // lot in transit (when supplier ships to carrier or fractionator)
  DELIVERED_TO_CARRIER // lot delivered to carrier warehouse
  DELIVERED_TO_FRACTIONATOR // lot delivered to fractionator warehouse
  IN_PACKAGE // lot being packaged into shipments
}

model LotPayment {
  id        Int           @id @default(autoincrement())
  amount    Float
  status    PaymentStatus
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  lotId Int
  lot   Lot @relation(fields: [lotId], references: [id], onDelete: Cascade)
}

model Package {
  id         Int           @id @default(autoincrement())
  status     PackageStatus
  trackingId String
  weight     Float?
  volume     Float?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  lotId     Int
  lot       Lot               @relation(fields: [lotId], references: [id], onDelete: Cascade)
  shipments ShipmentPackage[]
}

enum PackageStatus {
  CREATED // package created but not yet bundled into a shipment
  IN_TRANSIT // package is in transit
  ARRIVED // package has arrived at destination
  DELIVERED // package has been delivered
}

model ShipmentPackage {
  shipmentId Int
  packageId  Int

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  package  Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@id([shipmentId, packageId])
}

model ShipmentPayment {
  id        Int           @id @default(autoincrement())
  amount    Float
  status    PaymentStatus
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  shipmentId Int
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
}

model Event {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  date        DateTime
  location    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id          Int                @id @default(autoincrement())
  message     String
  type        NotificationType
  status      NotificationStatus
  scheduledAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channelId Int
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}

enum NotificationStatus {
  PENDING
  SENT
  READ
  FAILED
  RETRY
}

model Channel {
  id          Int         @id @default(autoincrement())
  type        ChannelType
  name        String
  description String?
  token       String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  notifications Notification[]
}

model SavedPaymentCard {
  id             Int      @id @default(autoincrement())
  cardholderName String
  cardLast4      String
  expiryMonth    Int
  expiryYear     Int
  cardBrand      String
  isDefault      Boolean  @default(false)
  isActive       Boolean  @default(true)
  deleted        Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum ChannelType {
  EMAIL
  SMS
  PUSH
  IN_APP
  WHATSAPP
}
